# 图片编辑功能测试指南

## 测试目的

验证修复后的图文混排消息处理功能,确保用户发送图片编辑指令时,机器人能够**返回生成的图片**而不是只返回文字描述。

## 测试环境

- ✅ 钉钉机器人: 运行中
- ✅ 图片服务器: 运行中 (端口 8090)
- ✅ 修复版本: `8ceec9e` (2026-03-01 00:10)

## 测试场景

### 场景1: 图片元素替换 ⭐

**操作步骤**:
1. 在钉钉中找一张包含动物的图片(如马、狗等)
2. 发送图片到机器人
3. 在同一条消息中输入文字: "将马替换为牛"

**预期结果**:
- ✅ 立即收到: "收到您的消息,正在处理中..."
- ✅ 等待 1-2 分钟
- ✅ 收到 Markdown 格式消息:
  ```
  🎨 图片已生成!
  
  完成!我已经将图片中的马替换为牛。
  图片中现在是...
  
  [图片预览]
  
  图片信息:
  - 文件大小: xxx KB
  - 访问链接: [点击查看]
  ```
- ✅ **图片可以直接在钉钉中显示**
- ✅ 点击图片可以查看大图

**错误表现** (修复前):
- ❌ 只收到文字: "图片已保存到: `/root/generated-images/xxx.png`"
- ❌ 看不到图片本身

---

### 场景2: 风格转换

**操作步骤**:
1. 发送任意图片
2. 输入文字: "转换为水彩画风格"

**预期结果**:
- ✅ 收到包含新图片的 Markdown 消息
- ✅ 图片风格已转换

---

### 场景3: 图片增强

**操作步骤**:
1. 发送一张稍显模糊的图片
2. 输入文字: "增强画质"

**预期结果**:
- ✅ 收到增强后的图片
- ✅ 而不是只有路径文字

---

### 场景4: 添加元素

**操作步骤**:
1. 发送一张风景图
2. 输入文字: "在天空中添加一只飞鸟"

**预期结果**:
- ✅ 收到添加了飞鸟的新图片
- ✅ 图片可直接显示

---

### 场景5: 纯文字生图 (对照组)

**操作步骤**:
1. 发送纯文字消息(不带图片): "生成一只可爱的小猫"

**预期结果**:
- ✅ 触发专门的生图流程
- ✅ 收到生成的图片
- ✅ 与场景1-4使用相同的图片发送格式

**说明**: 这是对照组,验证纯文字生图功能不受影响

---

### 场景6: 普通图文问答 (负面测试)

**操作步骤**:
1. 发送一张动物图片
2. 输入文字: "这是什么动物?"

**预期结果**:
- ✅ 收到文字回答
- ✅ 不会触发图片生成和发送
- ✅ 正常的文字交互

**说明**: 验证不会误触发图片发送

---

## 验证要点

### ✅ 核心功能
- [ ] 图片可以在钉钉中直接显示(不是路径文字)
- [ ] 图片质量良好,清晰可见
- [ ] 点击图片可以查看大图
- [ ] 图片加载速度正常(< 5秒)

### ✅ 消息格式
- [ ] Markdown 格式正确
- [ ] 包含标题: "🎨 图片已生成!"
- [ ] 包含描述文字
- [ ] 包含图片信息(文件大小、链接)

### ✅ 用户体验
- [ ] 没有收到重复消息
- [ ] 没有收到错误提示
- [ ] 处理时间合理(1-2分钟)
- [ ] 图片URL可访问

### ✅ 异常处理
- [ ] 如果图片生成失败,有友好提示
- [ ] 不会崩溃或无响应

---

## 日志监控

测试时可以实时查看日志:

```bash
# 机器人日志
tail -f /var/log/dingtalk-bot.log | grep -E "图片|生成|Markdown|extract"

# 查看特定关键信息
tail -f /var/log/dingtalk-bot.log | grep "从响应中提取到图片路径"
```

### 成功标志

如果看到以下日志,说明功能正常:
```
从响应中提取到图片路径: /root/generated-images/xxx.png
检测到响应中包含生成的图片: /root/generated-images/xxx.png
图片已复制到: /root/project-wb/dingtalk_bot/imagegen/codebuddy-generated_xxx.png
已通过 Markdown 格式发送生成的图片: http://119.28.50.67:8090/xxx.png
```

---

## 问题排查

### 问题1: 仍然只收到路径文字

**可能原因**:
- 服务未重启
- 代码未更新

**解决方法**:
```bash
# 检查服务状态
systemctl status dingtalk-bot.service

# 重启服务
systemctl restart dingtalk-bot.service

# 查看日志
tail -50 /var/log/dingtalk-bot.log
```

---

### 问题2: 图片无法显示

**可能原因**:
- 图片服务器未运行
- URL无法访问
- 防火墙/安全组限制

**解决方法**:
```bash
# 检查图片服务器
systemctl status image-server.service

# 测试图片URL访问
curl -I http://119.28.50.67:8090/

# 运行验证脚本
/root/project-wb/dingtalk_bot/verify_image_server.sh
```

---

### 问题3: 图片提取失败

**症状**: 日志中显示 "从响应中提取到图片路径: None"

**可能原因**:
- CodeBuddy响应格式变化
- 正则表达式不匹配

**解决方法**:
1. 查看完整响应: `grep "Response text" /var/log/dingtalk-bot.log | tail -1`
2. 检查图片路径格式
3. 调整正则表达式

---

## 快速命令

```bash
# 重启所有服务
systemctl restart dingtalk-bot.service image-server.service

# 查看最近10条关键日志
tail -100 /var/log/dingtalk-bot.log | grep -E "图片|提取|复制|发送" | tail -10

# 查看生成的图片
ls -lht /root/project-wb/dingtalk_bot/imagegen/ | head -5

# 验证图片服务器
curl http://119.28.50.67:8090/ 2>&1 | grep -i "200\|directory"

# 检查进程
ps aux | grep -E "bot.py|image_server.py" | grep -v grep
```

---

## 测试报告模板

完成测试后,请填写:

**测试人**: _______  
**测试时间**: 2026-03-01  
**测试场景**: 场景1 / 场景2 / ...  

| 测试项 | 预期 | 实际 | 通过 |
|--------|------|------|------|
| 图片显示 | ✅ 显示图片 | ✅ / ❌ | Y / N |
| 消息格式 | ✅ Markdown | ✅ / ❌ | Y / N |
| 无重复消息 | ✅ 单条 | ✅ / ❌ | Y / N |
| 处理时间 | < 2分钟 | ___ 秒 | Y / N |

**问题描述** (如有):


**截图** (如有):


**结论**: 通过 / 不通过 / 部分通过

---

**最后更新**: 2026-03-01 00:12  
**相关修复**: `8ceec9e` - 支持从CodeBuddy响应中自动提取并发送生成的图片
