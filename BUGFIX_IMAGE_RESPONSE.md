# å›¾æ–‡æ··æ’æ¶ˆæ¯å›¾ç‰‡è¿”å›ä¿®å¤

## é—®é¢˜æè¿°

å½“ç”¨æˆ·åœ¨é’‰é’‰ä¸­å‘é€**å›¾æ–‡æ··æ’æ¶ˆæ¯**(å›¾ç‰‡ + æ–‡å­—æŒ‡ä»¤,å¦‚"å°†é©¬æ›¿æ¢ä¸ºç‰›")è¦æ±‚ç¼–è¾‘å›¾ç‰‡æ—¶:

### é¢„æœŸè¡Œä¸º
- âœ… CodeBuddy ç”Ÿæˆæ–°å›¾ç‰‡
- âœ… æœºå™¨äººè¿”å›ç”Ÿæˆçš„å›¾ç‰‡
- âœ… ç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨é’‰é’‰ä¸­æŸ¥çœ‹ç»“æœ

### å®é™…è¡Œä¸º
- âœ… CodeBuddy æˆåŠŸç”Ÿæˆäº†æ–°å›¾ç‰‡
- âŒ æœºå™¨äººåªè¿”å›æ–‡å­—æè¿°
- âŒ ç”¨æˆ·çœ‹ä¸åˆ°ç”Ÿæˆçš„å›¾ç‰‡

**ç”¨æˆ·æ”¶åˆ°çš„æ¶ˆæ¯**:
```
å®Œæˆ!æˆ‘å·²ç»å°†å›¾ç‰‡ä¸­çš„é©¬æ›¿æ¢ä¸ºç‰›ã€‚ç¼–è¾‘åçš„å›¾ç‰‡å·²ä¿å­˜åˆ°:

`/root/generated-images/å°†ç”»é¢ä¸­çš„é©¬æ›¿æ¢ä¸ºä¸€åªå¯çˆ±çš„ç‰›_ç‰›çš„é¢œè‰²ä¸ºæ£•è‰²_æˆ´ç€ç²‰è‰²ä¸å¸¦_2026-02-28T16-04-01.png`

å›¾ç‰‡ä¸­ç°åœ¨æ˜¯ä¸€åªå¯çˆ±çš„ä¼é¹…å’Œä¸€åªæˆ´ç€ç²‰è‰²ä¸å¸¦çš„å¿ƒå½¢åŠå çš„æ£•è‰²ç‰›...
```

**é—®é¢˜**: åªæœ‰æ–‡å­—,æ²¡æœ‰å›¾ç‰‡!

## æ ¹æœ¬åŸå› 

### æ¶ˆæ¯å¤„ç†æµç¨‹åˆ†æ

å›¾æ–‡æ··æ’æ¶ˆæ¯çš„å¤„ç†æµç¨‹:

```
ç”¨æˆ·å‘é€å›¾æ–‡æ¶ˆæ¯(å›¾ç‰‡ + "å°†é©¬æ›¿æ¢ä¸ºç‰›")
    â†“
MyCallbackHandler.process()
    â†“
æ£€æµ‹åˆ°éç”Ÿå›¾è¯·æ±‚ (ä¸åŒ…å«"ç”Ÿæˆå›¾ç‰‡"ç­‰å…³é”®è¯)
    â†“
èµ° _process_message_sync() åŒæ­¥å¤„ç†
    â†“
è°ƒç”¨ codebuddy_client.chat_with_image()
    â†“
CodeBuddy ç”Ÿæˆæ–°å›¾ç‰‡å¹¶è¿”å›æ–‡å­—æè¿°
    â†“
âŒ ç›´æ¥å°†æ–‡å­—æè¿°å‘é€ç»™ç”¨æˆ·
    â†“
ç”¨æˆ·åªçœ‹åˆ°æ–‡å­—,çœ‹ä¸åˆ°å›¾ç‰‡
```

### æ ¸å¿ƒé—®é¢˜

1. **å“åº”æ ¼å¼è¯†åˆ«ä¸è¶³**: 
   - `_process_message_sync()` åªè¿”å›æ–‡å­—å“åº”
   - æ²¡æœ‰æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„

2. **å›¾ç‰‡è·¯å¾„æœªæå–**: 
   - CodeBuddy å“åº”åŒ…å«è·¯å¾„: `/root/generated-images/xxx.png`
   - ä½†æœºå™¨äººæ²¡æœ‰æå–å’Œå¤„ç†è¿™ä¸ªè·¯å¾„

3. **å‘é€é€»è¾‘å•ä¸€**: 
   - åªæœ‰ `_process_image_generation()` ä¼šå‘é€å›¾ç‰‡
   - æ™®é€šæ¶ˆæ¯å¤„ç†ä¸ä¼šå‘é€å›¾ç‰‡

## è§£å†³æ–¹æ¡ˆ

### å®ç°æ€è·¯

åœ¨æ™®é€šæ¶ˆæ¯å¤„ç†æµç¨‹ä¸­æ·»åŠ å›¾ç‰‡æ£€æµ‹å’Œå‘é€é€»è¾‘:

```
ç”¨æˆ·å‘é€å›¾æ–‡æ¶ˆæ¯(å›¾ç‰‡ + "å°†é©¬æ›¿æ¢ä¸ºç‰›")
    â†“
MyCallbackHandler.process()
    â†“
_process_message_sync() è·å–å“åº”
    â†“
âœ… _extract_generated_image() æ£€æµ‹å“åº”ä¸­çš„å›¾ç‰‡è·¯å¾„
    â†“
å‘ç°å›¾ç‰‡è·¯å¾„ â†’ _send_generated_image() å‘é€å›¾ç‰‡
    æˆ–
æœªå‘ç°å›¾ç‰‡ â†’ æ­£å¸¸å‘é€æ–‡å­—å“åº”
```

### ä»£ç å®ç°

#### 1. ä¿®æ”¹æ¶ˆæ¯å¤„ç†é€»è¾‘ (bot.py:164-186)

```python
# 3. å‘é€æœ€ç»ˆç»“æœ
if result:
    # æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„
    generated_image = self._extract_generated_image(result)
    
    if generated_image:
        # å“åº”ä¸­åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡,å‘é€å›¾ç‰‡
        logger.info(f"æ£€æµ‹åˆ°å“åº”ä¸­åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡: {generated_image}")
        self._send_generated_image(message, generated_image, result)
    else:
        # æ™®é€šæ–‡æœ¬å“åº”
        # ... æ­£å¸¸çš„ Markdown æˆ–æ–‡æœ¬å‘é€é€»è¾‘ ...
```

#### 2. æ·»åŠ å›¾ç‰‡è·¯å¾„æå–æ–¹æ³• (bot.py:692-719)

```python
def _extract_generated_image(self, response_text: str) -> str:
    """
    ä»CodeBuddyå“åº”ä¸­æå–ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„
    
    æ”¯æŒçš„æ ¼å¼:
    - `åå¼•å·åŒ…è£¹`: `/root/generated-images/xxx.png`
    - ç›´æ¥è·¯å¾„: /root/generated-images/xxx.png
    
    Returns:
        å›¾ç‰‡è·¯å¾„,å¦‚æœæ²¡æ‰¾åˆ°è¿”å›None
    """
    import re
    
    patterns = [
        r'`(/root/generated-images/[^`]+\.(?:png|jpg|jpeg|gif|webp))`',  # åå¼•å·
        r'(/root/generated-images/\S+\.(?:png|jpg|jpeg|gif|webp))',      # æ— åŒ…è£¹
    ]
    
    for pattern in patterns:
        match = re.search(pattern, response_text)
        if match:
            image_path = match.group(1)
            logger.info(f"ä»å“åº”ä¸­æå–åˆ°å›¾ç‰‡è·¯å¾„: {image_path}")
            return image_path
    
    return None
```

#### 3. æ·»åŠ å›¾ç‰‡å‘é€æ–¹æ³• (bot.py:721-785)

```python
def _send_generated_image(self, message: ChatbotMessage, image_path: str, original_response: str):
    """
    å‘é€CodeBuddyç”Ÿæˆçš„å›¾ç‰‡
    """
    import os
    import shutil
    import uuid
    from pathlib import Path
    
    try:
        # 1. æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å­˜åœ¨
        if not os.path.exists(image_path):
            logger.warning(f"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: {image_path}")
            self.reply_text(original_response, message)
            return
        
        # 2. å¤åˆ¶å›¾ç‰‡åˆ° imagegen ç›®å½•
        imagegen_dir = Path(__file__).parent / "imagegen"
        new_filename = f"codebuddy-generated_{uuid.uuid4().hex[:16]}{file_ext}"
        target_path = imagegen_dir / new_filename
        shutil.copy2(image_path, target_path)
        
        # 3. æ„å»ºå›¾ç‰‡ URL
        image_url = f"{IMAGE_SERVER_URL}/{new_filename}"
        
        # 4. ä»åŸå§‹å“åº”ä¸­æå–æè¿°(å»æ‰è·¯å¾„)
        description = re.sub(r'`/root/generated-images/[^`]+`', '', original_response)
        
        # 5. ä½¿ç”¨ Markdown æ ¼å¼å‘é€å›¾ç‰‡
        markdown_text = f"""# ğŸ¨ å›¾ç‰‡å·²ç”Ÿæˆ!

{description}

![ç”Ÿæˆçš„å›¾ç‰‡]({image_url})

**å›¾ç‰‡ä¿¡æ¯**:
- æ–‡ä»¶å¤§å°: {file_size:.1f} KB
- è®¿é—®é“¾æ¥: [{new_filename}]({image_url})
"""
        
        self.reply_markdown("å›¾ç‰‡ç”Ÿæˆå®Œæˆ", markdown_text, message)
        
    except Exception as e:
        # å‡ºé”™æ—¶å‘é€åŸå§‹å“åº”
        self.reply_text(original_response, message)
```

### å…³é”®ç‰¹æ€§

âœ… **è‡ªåŠ¨æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å“åº”ä¸­çš„å›¾ç‰‡è·¯å¾„  
âœ… **æ™ºèƒ½æå–**: æ”¯æŒå¤šç§è·¯å¾„æ ¼å¼(åå¼•å·ã€ç›´æ¥è·¯å¾„)  
âœ… **å›¾ç‰‡å¤åˆ¶**: å°†ç”Ÿæˆçš„å›¾ç‰‡å¤åˆ¶åˆ° imagegen ç›®å½•  
âœ… **URLç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡è®¿é—® URL  
âœ… **æè¿°æ¸…ç†**: ä»åŸå§‹å“åº”ä¸­ç§»é™¤è·¯å¾„,ä¿ç•™æè¿°æ–‡å­—  
âœ… **å¼‚å¸¸å¤„ç†**: å‡ºé”™æ—¶é™çº§ä¸ºå‘é€åŸå§‹æ–‡å­—å“åº”  

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1: å›¾ç‰‡ç¼–è¾‘

**æ“ä½œ**: 
1. åœ¨é’‰é’‰ä¸­å‘é€ä¸€å¼ å›¾ç‰‡
2. é™„åŠ æ–‡å­—: "å°†é©¬æ›¿æ¢ä¸ºç‰›"

**é¢„æœŸç»“æœ**:
- âœ… æ”¶åˆ° "æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯,æ­£åœ¨å¤„ç†ä¸­..."
- âœ… ç­‰å¾…çº¦1-2åˆ†é’Ÿ
- âœ… æ”¶åˆ° Markdown æ ¼å¼çš„æ¶ˆæ¯
- âœ… æ¶ˆæ¯åŒ…å«:
  - ğŸ¨ å›¾ç‰‡å·²ç”Ÿæˆ!
  - æè¿°æ–‡å­—
  - å›¾ç‰‡é¢„è§ˆ(![å›¾ç‰‡](URL))
  - å›¾ç‰‡ä¿¡æ¯(æ–‡ä»¶å¤§å°ã€è®¿é—®é“¾æ¥)

### æµ‹è¯•åœºæ™¯2: å›¾ç‰‡é£æ ¼è½¬æ¢

**æ“ä½œ**:
1. å‘é€å›¾ç‰‡ + æ–‡å­—: "è½¬æ¢ä¸ºæ°´å½©ç”»é£æ ¼"

**é¢„æœŸç»“æœ**:
- âœ… è‡ªåŠ¨æ£€æµ‹å“åº”ä¸­çš„ç”Ÿæˆå›¾ç‰‡
- âœ… è¿”å›å›¾ç‰‡è€Œä¸æ˜¯è·¯å¾„æ–‡å­—

### æµ‹è¯•åœºæ™¯3: æ™®é€šå›¾æ–‡æ¶ˆæ¯

**æ“ä½œ**:
1. å‘é€å›¾ç‰‡ + æ–‡å­—: "è¿™æ˜¯ä»€ä¹ˆåŠ¨ç‰©?"

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸è¿”å›æ–‡å­—å›ç­”
- âœ… ä¸è§¦å‘å›¾ç‰‡å‘é€(å› ä¸ºæ²¡æœ‰ç”Ÿæˆæ–°å›¾ç‰‡)

## æŠ€æœ¯ç»†èŠ‚

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼

```python
(?:png|jpg|jpeg|gif|webp)
```

### æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

1. **åå¼•å·åŒ…è£¹æ ¼å¼**:
   ```
   `/root/generated-images/xxx.png`
   ```
   æ­£åˆ™: ``r'`(/root/generated-images/[^`]+\.(?:png|jpg|jpeg|gif|webp))`'``

2. **ç›´æ¥è·¯å¾„æ ¼å¼**:
   ```
   /root/generated-images/xxx.png
   ```
   æ­£åˆ™: `r'(/root/generated-images/\S+\.(?:png|jpg|jpeg|gif|webp))'`

### æ–‡ä»¶å‘½åè§„åˆ™

ç”Ÿæˆçš„æ–‡ä»¶åæ ¼å¼:
```
codebuddy-generated_{16ä½UUID}.{åŸæ‰©å±•å}
```

ç¤ºä¾‹:
```
codebuddy-generated_a1b2c3d4e5f6g7h8.png
```

### å›¾ç‰‡è®¿é—®URL

```
http://119.28.50.67:8090/codebuddy-generated_xxx.png
```

## æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸåœºæ™¯æ—¥å¿—

```
2026-03-01 00:10:15,123 - __main__ - INFO - æ”¶åˆ°æ¶ˆæ¯ç±»å‹: richText, æ¶ˆæ¯ID: msgXXX
2026-03-01 00:10:15,124 - __main__ - INFO - å¤„ç†å¯Œæ–‡æœ¬æ¶ˆæ¯: text=å°†é©¬æ›¿æ¢ä¸ºç‰›, image_code=xxx
2026-03-01 00:10:15,234 - codebuddy_client - INFO - å‘é€è¯·æ±‚åˆ°CodeBuddy
2026-03-01 00:11:25,567 - codebuddy_client - INFO - Response status: 200
2026-03-01 00:11:25,568 - __main__ - INFO - ä»å“åº”ä¸­æå–åˆ°å›¾ç‰‡è·¯å¾„: /root/generated-images/xxx.png
2026-03-01 00:11:25,569 - __main__ - INFO - æ£€æµ‹åˆ°å“åº”ä¸­åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡: /root/generated-images/xxx.png
2026-03-01 00:11:25,570 - __main__ - INFO - å›¾ç‰‡å·²å¤åˆ¶åˆ°: /root/project-wb/dingtalk_bot/imagegen/codebuddy-generated_xxx.png
2026-03-01 00:11:25,678 - __main__ - INFO - å·²é€šè¿‡ Markdown æ ¼å¼å‘é€ç”Ÿæˆçš„å›¾ç‰‡: http://119.28.50.67:8090/xxx.png
```

### æ™®é€šæ–‡æœ¬å“åº”æ—¥å¿—

```
2026-03-01 00:12:30,123 - __main__ - INFO - æ”¶åˆ°æ¶ˆæ¯ç±»å‹: text, æ¶ˆæ¯ID: msgYYY
2026-03-01 00:12:30,456 - codebuddy_client - INFO - Response text: è¿™æ˜¯ä¸€åªä¼é¹…...
2026-03-01 00:12:30,457 - __main__ - INFO - ä»å“åº”ä¸­æå–åˆ°å›¾ç‰‡è·¯å¾„: None
2026-03-01 00:12:30,458 - __main__ - INFO - å‡†å¤‡å‘é€ Markdown æ¶ˆæ¯...
```

## ç›¸å…³æ–‡ä»¶

- `bot.py` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
  - `_extract_generated_image()` - æ–°å¢æ–¹æ³•
  - `_send_generated_image()` - æ–°å¢æ–¹æ³•
  - æ¶ˆæ¯å¤„ç†é€»è¾‘ä¿®æ”¹

- æäº¤è®°å½•: `8ceec9e`

## å…¼å®¹æ€§

- âœ… å‘åå…¼å®¹: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… æ— éœ€é…ç½®: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†
- âœ… é™çº§å¤„ç†: å‡ºé”™æ—¶è¿”å›åŸå§‹æ–‡å­—

## æœªæ¥ä¼˜åŒ–å»ºè®®

1. **æ”¯æŒæ›´å¤šè·¯å¾„æ ¼å¼**
   - ç›¸å¯¹è·¯å¾„
   - ç½‘ç»œURL

2. **æ‰¹é‡å›¾ç‰‡å¤„ç†**
   - å“åº”ä¸­åŒ…å«å¤šå¼ å›¾ç‰‡
   - è‡ªåŠ¨å‘é€å›¾ç‰‡é›†åˆ

3. **å›¾ç‰‡æ ¼å¼è½¬æ¢**
   - è‡ªåŠ¨è½¬æ¢ä¸º WebP èŠ‚çœå¸¦å®½
   - è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡

4. **ç¼“å­˜æœºåˆ¶**
   - é¿å…é‡å¤ç”Ÿæˆç›¸åŒå›¾ç‰‡
   - Redis ç¼“å­˜å›¾ç‰‡URL

---

**ä¿®å¤æ—¶é—´**: 2026-03-01 00:10  
**å½±å“èŒƒå›´**: å›¾æ–‡æ··æ’æ¶ˆæ¯å¤„ç†  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯
