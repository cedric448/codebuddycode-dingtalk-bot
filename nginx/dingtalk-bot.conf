# 钉钉机器人服务代理配置
# 
# 部署说明：
# 1. 将此文件复制到 /etc/nginx/conf.d/
#    sudo cp nginx/dingtalk-bot.conf /etc/nginx/conf.d/
# 
# 2. 修改 server_name 为你的服务器IP或域名
# 
# 3. 测试配置
#    sudo nginx -t
# 
# 4. 重载Nginx
#    sudo systemctl reload nginx

server {
    listen 80;
    server_name 119.28.50.67;  # 修改为你的服务器IP或域名
    
    # 图片服务路径
    # 代理到本地8090端口的HTTP图片服务器
    location /dingtalk-images/ {
        proxy_pass http://127.0.0.1:8090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 图片缓存设置 (7天)
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        
        # CORS 支持
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
    }
    
    # CodeBuddy API 代理
    # 代理到本地3000端口的CodeBuddy服务
    location /agent {
        # Bearer Token 验证
        # 检查 Authorization 头是否包含正确的 token
        set $auth_header $http_authorization;
        set $valid_token "Bearer 06d56890c91f19135e6d8020e8448a35b31cb9b7cedd7da2842f0616ccadeac4";
        
        # 验证 token
        if ($auth_header != $valid_token) {
            return 401 '{"error": "Unauthorized", "message": "Invalid or missing Authorization token"}';
        }
        
        proxy_pass http://127.0.0.1:3000/agent;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置 (CodeBuddy 可能需要较长时间处理)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 缓冲设置 (禁用缓冲以支持流式响应)
        proxy_buffering off;
        proxy_request_buffering off;
        
        # CORS 支持
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        
        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
}
