# 异步功能测试指南

## 测试目的

验证异步任务处理机制是否正确解决 webhook 超时问题。

## 测试环境

- **服务状态**: 确保服务正在运行
  ```bash
  sudo systemctl status dingtalk-bot
  ```

- **日志监控**: 开启日志实时查看
  ```bash
  tail -f /var/log/dingtalk-bot.log
  ```

## 测试用例

### 测试 1: 短消息（同步处理）

**目的**: 验证短消息仍使用原有流程

**步骤**:
1. 在钉钉中发送: `测试`
2. 观察日志和响应

**预期结果**:
- 日志显示: `收到消息类型: text`
- 日志**不显示**: `检测到长时间任务`
- 立即收到回复（< 5秒）

**验证命令**:
```bash
grep "测试" /var/log/dingtalk-bot.log -A 5
```

---

### 测试 2: 快速查询（同步处理）

**目的**: 验证快速 API 请求不触发异步

**步骤**:
1. 在钉钉中发送: `今天北京天气怎么样？`
2. 观察响应时间

**预期结果**:
- 收到初始回复: "收到任务，正在处理中..."
- 15-30秒内收到天气信息
- 日志**不显示**: `检测到长时间任务`

**验证命令**:
```bash
grep "北京天气" /var/log/dingtalk-bot.log -A 10
```

---

### 测试 3: 长时间任务（异步处理）⭐

**目的**: 验证长时间任务异步处理和主动推送

**步骤**:
1. 在钉钉中发送: `使用 client analysis 分析公司 奥睿科`
2. 观察日志和响应

**预期结果**:

**立即响应** (< 3秒):
```
收到任务，正在后台处理中...

这是一个长时间任务，预计需要 2-5 分钟，完成后会主动推送结果给您。
```

**日志输出**:
```
[时间] - INFO - 收到消息类型: text
[时间] - INFO - 检测到长时间任务，使用异步处理    ✓ 关键日志
[时间] - INFO - 创建任务: [task-id], 用户: [user-id]
[时间] - INFO - 异步任务已启动: [task-id]
[时间] - INFO - 准备发送消息，长度: 85 字符
[时间] - INFO - 回复消息发送成功
[时间] - INFO - 后台任务开始执行: [task-id]
[时间] - INFO - 任务 [task-id] 状态更新: processing
```

**2-5 分钟后**:
```
[时间] - INFO - 任务 [task-id] 完成，耗时: XXX.XX秒
[时间] - INFO - 成功获取 access token                ✓ 使用主动推送
[时间] - INFO - 发送消息到用户 [user-id], 内容长度: XXXX
[时间] - INFO - 消息发送响应: {...}
[时间] - INFO - 任务结果已推送: [task-id]          ✓ 成功推送
```

**钉钉收到完整报告**:
```
奥睿科（ORICO）客户战略分析报告已完成。

## 报告生成结果
...
[完整分析报告]
```

**验证命令**:
```bash
# 查看完整流程
grep "client analysis" /var/log/dingtalk-bot.log -A 50 | tail -n 60

# 验证异步处理
grep "检测到长时间任务" /var/log/dingtalk-bot.log

# 验证主动推送
grep "任务结果已推送" /var/log/dingtalk-bot.log
```

---

### 测试 4: 其他长时间任务关键词

测试其他触发异步的关键词:

**测试消息**:
- `帮我生成一份详细分析报告`
- `进行市场调研分析`
- `分析公司 腾讯云`

**预期**: 都应该触发异步处理

**验证**:
```bash
grep "检测到长时间任务" /var/log/dingtalk-bot.log | tail -n 10
```

---

## 故障排查

### 问题 1: 没有触发异步处理

**症状**: 长时间任务仍然超时，没有看到"后台处理中"消息

**检查**:
```bash
# 1. 检查关键词匹配
grep "client analysis" /var/log/dingtalk-bot.log

# 2. 检查代码是否生效
grep "检测到长时间任务" /var/log/dingtalk-bot.log
```

**解决**: 
- 确认消息包含触发关键词
- 检查 `async_task_manager.py` 的关键词列表

---

### 问题 2: 主动推送失败

**症状**: 看到"后台任务完成"，但钉钉没收到消息

**检查**:
```bash
# 查看推送日志
grep "发送消息到用户\|消息发送响应\|发送消息失败" /var/log/dingtalk-bot.log | tail -n 20
```

**可能原因**:
1. Access token 获取失败
2. API 权限不足
3. User ID 错误

**解决**:
```bash
# 检查 token 获取
grep "access token" /var/log/dingtalk-bot.log

# 检查错误信息
grep "ERROR" /var/log/dingtalk-bot.log | tail -n 20
```

---

### 问题 3: 任务执行失败

**症状**: 后台任务启动后没有完成

**检查**:
```bash
# 查看后台任务执行
grep "后台任务" /var/log/dingtalk-bot.log

# 查看错误
grep "后台任务执行失败" /var/log/dingtalk-bot.log
```

---

## 性能监控

### 任务耗时统计

```bash
# 查看任务完成时间
grep "任务.*完成，耗时" /var/log/dingtalk-bot.log | tail -n 10
```

### 成功率统计

```bash
# 成功推送的任务
success_count=$(grep "任务结果已推送" /var/log/dingtalk-bot.log | wc -l)

# 失败的任务
fail_count=$(grep "后台任务执行失败" /var/log/dingtalk-bot.log | wc -l)

echo "成功: $success_count, 失败: $fail_count"
```

---

## 成功标准

✅ **测试通过条件**:

1. 短消息（测试 1）: 同步返回 ✓
2. 快速查询（测试 2）: 同步返回 ✓
3. 长时间任务（测试 3）:
   - 立即收到"后台处理中"消息 ✓
   - 日志显示异步处理 ✓
   - 2-5分钟后收到完整报告 ✓
   - 日志显示主动推送成功 ✓

---

## 测试报告模板

```markdown
## 异步功能测试报告

**测试时间**: 2026-02-28 HH:MM
**测试人员**: [Your Name]
**服务版本**: 1.0

### 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 测试 1: 短消息 | ✅/❌ | |
| 测试 2: 快速查询 | ✅/❌ | |
| 测试 3: 长时间任务 | ✅/❌ | |
| 测试 4: 其他关键词 | ✅/❌ | |

### 问题记录

[记录遇到的问题和解决方案]

### 结论

- [ ] 功能正常，可以上线
- [ ] 存在问题，需要修复
```

---

**重要提示**: 

请在测试**测试 3（长时间任务）**时保持耐心，等待 2-5 分钟观察完整流程。这是最关键的测试用例！

如果测试失败，请提供完整的日志输出以便分析。
