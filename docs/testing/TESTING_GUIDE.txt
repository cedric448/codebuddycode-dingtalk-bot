╔════════════════════════════════════════════════════════════════════════════════╗
║                                                                                ║
║                     钉钉 Markdown 功能测试指南                                 ║
║                                                                                ║
╚════════════════════════════════════════════════════════════════════════════════╝

✅ 部署状态: 已完成
✅ 服务状态: 运行中 (PID: 796869)
✅ 配置状态: Markdown 已启用
✅ 模块状态: 所有模块加载成功

═══════════════════════════════════════════════════════════════════════════════

📋 测试场景

═══════════════════════════════════════════════════════════════════════════════

测试 1: 纯文本消息（验证向后兼容）
─────────────────────────────────────────────────────────────────────────────

在钉钉中发送:
  "你好"

预期结果:
  ✓ 立即收到 "收到任务，正在处理中..." 消息
  ✓ 几秒后收到 AI 回复（纯文本格式）
  ✓ 消息显示正常，无格式问题

日志验证:
  tail -f /var/log/dingtalk-bot.log | grep -E "收到|发送"

─────────────────────────────────────────────────────────────────────────────

测试 2: 包含 Markdown 标记的查询
─────────────────────────────────────────────────────────────────────────────

在钉钉中发送:
  "分析以下内容：# 标题1\n## 标题2\n- 列表项1\n- 列表项2"

预期结果:
  ✓ AI 返回包含 Markdown 格式的内容
  ✓ 系统自动检测并使用 Markdown 格式发送
  ✓ 消息在钉钉中正确渲染（有标题、列表等格式）

日志验证:
  tail -f /var/log/dingtalk-bot.log | grep -i markdown

─────────────────────────────────────────────────────────────────────────────

测试 3: 请求代码示例
─────────────────────────────────────────────────────────────────────────────

在钉钉中发送:
  "给我一个 Python 代码示例"

预期结果:
  ✓ AI 返回包含代码块的内容
  ✓ 代码块在钉钉中正确显示（等宽字体、语法高亮）

日志验证:
  tail -f /var/log/dingtalk-bot.log | grep "format_code_block"

─────────────────────────────────────────────────────────────────────────────

测试 4: 异步长时间任务（核心测试）
─────────────────────────────────────────────────────────────────────────────

在钉钉中发送:
  "使用 client analysis 分析公司 阿里巴巴"

预期结果:
  ✓ 立即收到 "收到任务，正在后台处理中..." 消息
  ✓ 2-5 分钟后收到详细的分析报告
  ✓ 报告以 Markdown 格式展示（标题、列表、引用等）

日志验证:
  tail -f /var/log/dingtalk-bot.log | grep -E "后台任务|Markdown"

实时监控:
  # 在另一个终端运行
  watch -n 2 'tail -20 /var/log/dingtalk-bot.log'

─────────────────────────────────────────────────────────────────────────────

测试 5: 混合内容测试
─────────────────────────────────────────────────────────────────────────────

在钉钉中发送:
  "分析一下今天的天气情况"

预期结果:
  ✓ 根据 API 返回自动选择格式
  ✓ 如果包含 Markdown，自动使用 Markdown 格式
  ✓ 否则使用纯文本格式

═══════════════════════════════════════════════════════════════════════════════

🔍 实时监控命令

═══════════════════════════════════════════════════════════════════════════════

# 实时查看所有日志
tail -f /var/log/dingtalk-bot.log

# 只看 Markdown 相关日志
tail -f /var/log/dingtalk-bot.log | grep -i markdown

# 只看消息发送日志
tail -f /var/log/dingtalk-bot.log | grep -E "发送|回复"

# 查看错误日志
tail -f /var/log/dingtalk-bot.log | grep -i error

# 实时监控（每 2 秒刷新）
watch -n 2 'tail -30 /var/log/dingtalk-bot.log'

═══════════════════════════════════════════════════════════════════════════════

📊 预期日志模式

═══════════════════════════════════════════════════════════════════════════════

纯文本消息:
  收到消息类型: text
  准备发送消息，长度: XXX 字符
  回复消息发送成功

Markdown 消息:
  收到消息类型: text
  准备发送 Markdown 消息: 标题=XXX, 内容长度=XXX 字符
  Markdown 消息发送成功

异步任务:
  检测到长时间任务，使用异步处理
  创建异步任务: [task_id]
  后台任务开始执行: [task_id]
  后台任务执行完成: [task_id]
  发送 markdown/text 消息到用户 XXX
  任务结果已推送: [task_id]

═══════════════════════════════════════════════════════════════════════════════

✅ 验证清单

═══════════════════════════════════════════════════════════════════════════════

部署前:
  [✓] 备份已完成
  [✓] 配置已更新
  [✓] 服务已重启
  [✓] 模块导入成功

功能测试:
  [ ] 测试 1: 纯文本消息
  [ ] 测试 2: Markdown 查询
  [ ] 测试 3: 代码示例
  [ ] 测试 4: 异步任务
  [ ] 测试 5: 混合内容

验证项:
  [ ] 消息能正常发送和接收
  [ ] Markdown 格式正确渲染
  [ ] 纯文本消息仍正常工作
  [ ] 异步任务能正常完成
  [ ] 日志中无错误
  [ ] 性能无明显下降

═══════════════════════════════════════════════════════════════════════════════

🚨 故障排查

═══════════════════════════════════════════════════════════════════════════════

问题: 收不到消息
解决:
  1. 检查服务状态: systemctl status dingtalk-bot
  2. 查看日志错误: grep ERROR /var/log/dingtalk-bot.log | tail -10
  3. 验证网络连接: curl -I https://api.dingtalk.com

问题: Markdown 不显示
解决:
  1. 检查配置: grep MARKDOWN /root/project-wb/dingtalk_bot/.env
  2. 验证模块: python3 -c "from markdown_utils import markdown_formatter"
  3. 查看日志: grep -i markdown /var/log/dingtalk-bot.log

问题: 服务异常
解决:
  1. 重启服务: systemctl restart dingtalk-bot
  2. 查看详细日志: journalctl -u dingtalk-bot -n 50 --no-pager
  3. 运行监控脚本: bash /root/project-wb/dingtalk_bot/monitor_markdown.sh

问题: 需要回滚
解决:
  cd /root/project-wb/dingtalk_bot
  cp backups/bot.py.backup.20260228 bot.py
  cp backups/dingtalk_sender.py.backup.20260228 dingtalk_sender.py
  cp backups/config.py.backup.20260228 config.py
  systemctl restart dingtalk-bot

═══════════════════════════════════════════════════════════════════════════════

📖 参考文档

═══════════════════════════════════════════════════════════════════════════════

功能文档:     /root/project-wb/dingtalk_bot/MARKDOWN_SUPPORT.md
部署指南:     /root/project-wb/dingtalk_bot/MARKDOWN_DEPLOYMENT.md
测试指南:     /root/project-wb/dingtalk_bot/TEST_MARKDOWN.md
实现总结:     /root/project-wb/dingtalk_bot/MARKDOWN_IMPLEMENTATION.md

═══════════════════════════════════════════════════════════════════════════════

现在可以开始在钉钉中测试了！

建议按顺序进行测试，每个测试完成后记录结果。
如遇到问题，请参考故障排查部分或查看相关文档。

═══════════════════════════════════════════════════════════════════════════════
