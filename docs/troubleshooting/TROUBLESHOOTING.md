# 钉钉机器人问题排查指南

## 问题：消息没有执行或没有响应

### 症状

用户发送消息后：
- 收到"收到任务，正在处理中..."的初始回复
- 但没有收到最终的处理结果

### 排查步骤

#### 1. 检查日志

```bash
# 查看最近的日志
tail -n 100 /var/log/dingtalk-bot.log

# 查看特定消息的处理流程
grep "你的消息内容" /var/log/dingtalk-bot.log -A 20
```

关键日志标记：
- `收到消息类型` - 消息接收
- `发送请求到CodeBuddy` - API 请求
- `Response status: 200` - API 响应成功
- `回复消息发送成功` - 响应已发送

#### 2. 检查 API 响应时间

```bash
# 查看请求和响应的时间差
grep "发送请求到CodeBuddy\|Response status" /var/log/dingtalk-bot.log | tail -n 10
```

**问题**：如果响应时间 > 60秒，钉钉的 session webhook 可能已过期。

#### 3. 检查消息长度

```bash
# 查看准备发送的消息长度
grep "准备发送消息，长度" /var/log/dingtalk-bot.log | tail -n 5
```

**限制**：钉钉单条消息限制约 20000 字符。

#### 4. 检查钉钉 API 响应

```bash
# 查看钉钉返回的响应
grep "钉钉响应" /var/log/dingtalk-bot.log | tail -n 5
```

正常响应示例：
```json
{"success": true}
```

错误响应示例：
```json
{"errcode": 40035, "errmsg": "invalid webhook url"}
```

### 常见问题和解决方案

#### 问题 1: Webhook 超时

**症状**：API 处理时间过长（> 60秒），响应显示发送成功但钉钉没有收到。

**原因**：钉钉的 session webhook 有效期约 60 秒。

**解决方案**：
1. **临时方案**：使用更快的模型或简化请求
2. **长期方案**：实现异步回调机制

```python
# 修改配置使用更快的模型
CODEBUDDY_MODEL=claude-3.5-sonnet  # 更快
# 而不是
CODEBUDDY_MODEL=kimi-k2.5-ioa  # 较慢
```

#### 问题 2: 消息过长

**症状**：长消息（> 20000 字符）发送失败。

**解决方案**：代码已实现自动分段，检查 `_send_long_text` 函数。

#### 问题 3: 重复发送

**症状**：同一条消息被处理多次。

**原因**：用户重复发送，或钉钉消息重试机制。

**识别**：查看日志中的时间戳，如果相同消息在短时间内出现多次，可能是重复发送。

#### 问题 4: 消息格式问题

**症状**：Markdown 格式在钉钉中显示异常。

**解决方案**：钉钉对 Markdown 支持有限，复杂格式可能不显示。

### 测试方法

#### 1. 发送简单消息测试

```
用户发送: "测试"
预期: 立即收到回复
```

#### 2. 发送需要处理的消息

```
用户发送: "今天北京天气怎么样？"
预期: 收到初始回复 + 30秒内收到天气信息
```

#### 3. 发送复杂任务

```
用户发送: "使用 client analysis 分析公司 XX"
预期: 收到初始回复 + 2-5分钟内收到分析报告
```

**注意**：如果超过 60 秒，webhook 可能已过期，需要实现异步方案。

### 调试模式

启用详细日志：

```bash
# 修改 .env
LOG_LEVEL=DEBUG

# 重启服务
sudo systemctl restart dingtalk-bot

# 查看详细日志
tail -f /var/log/dingtalk-bot.log
```

### 联系支持

如果问题仍未解决，请提供：
1. 完整的日志片段（脱敏后）
2. 消息内容和时间
3. 预期行为 vs 实际行为
4. API 响应时间

---

**最后更新**: 2026-02-28
