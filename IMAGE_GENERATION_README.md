# 图片生成功能说明

## 功能概述

钉钉机器人现在支持通过自然语言指令生成图片,包括:
- **文生图 (Text-to-Image)**: 根据文字描述生成图片
- **图生图 (Image-to-Image)**: 基于现有图片进行修改

## 使用方法

### 1. 文生图

在钉钉中发送包含生图关键词的消息,例如:

```
帮我画一张夕阳下的海滩
生成一张可爱的小猫图片
画个卡通风格的机器人
```

**支持的关键词:**
- 生成图片、生成图像、生成图、生成一张、生成一幅
- 画一张、画一幅、画个、画一个
- 帮我画、画一下、给我画
- 生图、创建图片、制作图片、做一张图
- 绘制、作图

### 2. 图生图

发送图片并附带修改指令,例如:

```
基于这张图,修改成蓝色调
改这张图的背景
图生图: 添加一些花朵
```

**支持的关键词:**
- 修改图片、改这张图、图片修改、图像修改
- 基于这张图、参考这张图、图生图

## 技术实现

### 核心模块

- **image_generator.py**: 图片生成核心模块
  - 关键词检测
  - 提示词提取
  - 调用 CodeBuddy 图片生成模型
  - 图片保存和管理

- **bot.py**: 集成生图功能到消息处理流程
  - 自动检测生图请求
  - 异步处理生图任务
  - 发送生成的图片

- **dingtalk_sender.py**: 扩展支持图片消息发送
  - 媒体文件上传
  - Base64 图片发送
  - 图片消息推送

### 工作流程

```
用户发送消息
    ↓
检测是否包含生图关键词
    ↓
识别生图类型 (文生图/图生图)
    ↓
提取提示词
    ↓
调用 CodeBuddy API (/model:text-to-image 或 /model:image-to-image)
    ↓
提取生成的图片路径
    ↓
复制到 imagegen 目录
    ↓
通过钉钉发送图片给用户
```

### 文件结构

```
dingtalk_bot/
├── image_generator.py          # 图片生成模块
├── imagegen/                   # 生成的图片存储目录 (自动创建)
│   └── text-to-image_*.png    # 文生图结果
│   └── image-to-image_*.png   # 图生图结果
├── test_image_generation.py   # 功能测试脚本
└── bot.py                      # 主程序 (已集成生图功能)
```

## 测试

### 运行测试脚本

```bash
cd /root/project-wb/dingtalk_bot
./venv/bin/python test_image_generation.py
```

测试脚本会:
1. 测试关键词检测功能
2. 测试提示词提取功能
3. 可选: 测试实际的 API 调用

### 在钉钉测试

1. 在钉钉中 @机器人
2. 发送测试消息,例如:
   - "帮我画一只可爱的小猫"
   - "生成一张日落风景图"
3. 等待机器人生成并返回图片

## 配置说明

### 环境变量

确保 `.env` 文件中配置了以下参数:

```bash
# CodeBuddy API 配置
CODEBUDDY_API_URL=http://your-server-ip:port/agent
CODEBUDDY_API_TOKEN=your-api-token

# 钉钉配置
DINGTALK_CLIENT_ID=your-client-id
DINGTALK_CLIENT_SECRET=your-client-secret
```

### 模型选择

图片生成功能使用 CodeBuddy 的以下模型:
- **文生图**: `/model:text-to-image`
- **图生图**: `/model:image-to-image`

## 注意事项

1. **生成时间**: 图片生成通常需要 10-30 秒,请耐心等待
2. **图片质量**: 生成质量取决于提示词的详细程度和清晰度
3. **存储空间**: 生成的图片保存在 `imagegen/` 目录,定期清理以节省空间
4. **API 限制**: 注意 CodeBuddy API 的调用频率限制

## 故障排查

### 问题: 生图请求未被识别

**解决方案:**
- 检查消息是否包含支持的关键词
- 使用更明确的生图指令,如"帮我画一张..."

### 问题: 图片生成失败

**可能原因:**
1. CodeBuddy API 未正确配置
2. 网络连接问题
3. 提示词过于复杂或不清晰

**排查步骤:**
```bash
# 查看日志
tail -100 /var/log/dingtalk-bot.log | grep "image_generator"

# 检查 API 配置
cat .env | grep CODEBUDDY

# 手动测试 API
./venv/bin/python test_image_generation.py
```

### 问题: 图片无法发送到钉钉

**解决方案:**
- 检查图片文件是否生成成功
- 查看钉钉 API 响应日志
- 确认图片大小在钉钉限制范围内

## 未来改进

- [ ] 支持更多的图片风格参数
- [ ] 添加图片尺寸和分辨率配置
- [ ] 实现图片生成队列管理
- [ ] 支持批量生图
- [ ] 添加图片缓存机制
- [ ] 优化提示词自动增强

## 版本历史

### v1.0.0 (2026-02-28)
- 实现基础的文生图功能
- 实现基础的图生图功能
- 自动关键词检测
- 图片保存到本地目录
- 通过钉钉发送图片
