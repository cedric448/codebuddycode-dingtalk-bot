# é’‰é’‰æœºå™¨äºº - CodeBuddy é›†æˆæœåŠ¡

åŸºäº dingtalk-stream SDK å®ç°çš„é’‰é’‰æœºå™¨äººï¼Œé›†æˆ CodeBuddy HTTP APIï¼Œæ”¯æŒ Stream æ¨¡å¼ã€ç¾¤èŠ/å•èŠã€Markdown æ ¼å¼å›å¤ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **Stream æ¨¡å¼**ï¼šåŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€
- **ç¾¤èŠæ”¯æŒ**ï¼šæ”¯æŒ @æœºå™¨äºº è¿›è¡Œç¾¤èŠäº’åŠ¨
- **å•èŠæ”¯æŒ**ï¼šæ”¯æŒä¸€å¯¹ä¸€ç§èŠ
- **æ¶ˆæ¯ç±»å‹**ï¼š
  - çº¯æ–‡å­—å¤„ç†
  - çº¯å›¾ç‰‡å¤„ç†ï¼ˆä¸‹è½½å›¾ç‰‡åå‘é€åˆ° CodeBuddyï¼‰
  - å¯Œæ–‡æœ¬å¤„ç†ï¼ˆæ–‡å­—+å›¾ç‰‡ï¼‰
- **å¼‚æ­¥ä»»åŠ¡å¤„ç†**ï¼šâ­ æ–°åŠŸèƒ½
  - æ™ºèƒ½è¯†åˆ«é•¿æ—¶é—´ä»»åŠ¡ï¼ˆclient analysisã€å…¬å¸åˆ†æç­‰ï¼‰
  - ç«‹å³è¿”å›åˆå§‹å“åº”ï¼Œåå°å¤„ç†
  - å®Œæˆåä¸»åŠ¨æ¨é€ç»“æœï¼Œä¸å— webhook 60ç§’è¶…æ—¶é™åˆ¶
- **Markdown æ ¼å¼æ”¯æŒ**ï¼šâ­ æ–°åŠŸèƒ½
  - è‡ªåŠ¨æ£€æµ‹ API è¿”å›çš„ Markdown æ ¼å¼
  - é€šè¿‡é’‰é’‰åŸç”Ÿ Markdown æ¶ˆæ¯ç±»å‹å±•ç¤º
  - æ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ã€è¡¨æ ¼ç­‰æ ¼å¼
  - å¯çµæ´»é…ç½®ï¼Œæ”¯æŒçº¯æ–‡æœ¬å’Œ Markdown æ··ç”¨
- **å›¾ç‰‡ç”ŸæˆåŠŸèƒ½**ï¼šâ­ æ–°åŠŸèƒ½
  - æ–‡ç”Ÿå›¾ï¼šé€šè¿‡æ–‡æœ¬æè¿°ç”Ÿæˆå›¾ç‰‡
  - å›¾ç”Ÿå›¾ï¼šä¸Šä¼ å›¾ç‰‡è¿›è¡Œç¼–è¾‘å’Œå˜æ¢
  - è‡ªåŠ¨éƒ¨ç½²HTTPé™æ€æœåŠ¡å™¨ï¼Œé€šè¿‡nginxåå‘ä»£ç†
  - é’‰é’‰åŸç”Ÿå›¾ç‰‡æ¶ˆæ¯å±•ç¤º
- **Systemd æœåŠ¡**ï¼šæ”¯æŒç³»ç»ŸæœåŠ¡ç®¡ç†ï¼Œå¼€æœºè‡ªå¯
- **æ—¥å¿—ç®¡ç†**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•

## ç³»ç»Ÿæ¶æ„

```
é’‰é’‰ç”¨æˆ· -> é’‰é’‰æœåŠ¡å™¨ -> Stream WebSocket -> é’‰é’‰æœºå™¨äººæœåŠ¡ -> CodeBuddy API
                                              |
                                              v
                                         æœ¬åœ°å›¾ç‰‡å­˜å‚¨
                                              |
                                              v
                                    HTTPå›¾ç‰‡æœåŠ¡å™¨ (ç«¯å£8090)
                                              |
                                              v
                                       Nginxåå‘ä»£ç† (ç«¯å£80)
                                              |
                                              v
                                         å…¬ç½‘è®¿é—®è·¯å¾„:
                                    /dingtalk-images/ -> å›¾ç‰‡æœåŠ¡
                                    /agent -> CodeBuddy API
```

## é¡¹ç›®ç»“æ„

```
dingtalk_bot/
â”œâ”€â”€ bot.py                     # ä¸»ç¨‹åºå…¥å£ï¼ˆæ”¯æŒå¼‚æ­¥ä»»åŠ¡ï¼‰
â”œâ”€â”€ config.py                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ codebuddy_client.py        # CodeBuddy API å®¢æˆ·ç«¯
â”œâ”€â”€ image_manager.py           # å›¾ç‰‡ç®¡ç†æ¨¡å—
â”œâ”€â”€ image_generator.py         # å›¾ç‰‡ç”Ÿæˆæ¨¡å— â­
â”œâ”€â”€ image_server.py            # HTTPå›¾ç‰‡æœåŠ¡å™¨ â­
â”œâ”€â”€ async_task_manager.py      # å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨ â­
â”œâ”€â”€ dingtalk_sender.py         # é’‰é’‰ä¸»åŠ¨æ¨é€å®¢æˆ·ç«¯ â­
â”œâ”€â”€ markdown_utils.py          # Markdown å·¥å…·å‡½æ•° â­
â”œâ”€â”€ requirements.txt           # Python ä¾èµ–
â”œâ”€â”€ .env                       # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .env.example               # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ images/                    # å›¾ç‰‡å­˜å‚¨ç›®å½•
â”œâ”€â”€ imagegen/                  # ç”Ÿæˆå›¾ç‰‡å­˜å‚¨ç›®å½• â­
â”‚
â”œâ”€â”€ README.md                  # æœ¬æ–‡æ¡£
â”œâ”€â”€ docs/                      # ğŸ“š æ–‡æ¡£ç›®å½• â­
â”‚   â”œâ”€â”€ README.md             # æ–‡æ¡£å¯¼èˆªç´¢å¼•
â”‚   â”œâ”€â”€ deployment/           # éƒ¨ç½²ç›¸å…³æ–‡æ¡£
â”‚   â”œâ”€â”€ troubleshooting/      # æ•…éšœæ’æŸ¥æ–‡æ¡£
â”‚   â”œâ”€â”€ features/             # åŠŸèƒ½æ–‡æ¡£
â”‚   â”œâ”€â”€ testing/              # æµ‹è¯•æ–‡æ¡£
â”‚   â””â”€â”€ architecture/         # æ¶æ„æ–‡æ¡£
â”‚
â”œâ”€â”€ nginx/                     # âš™ï¸ Nginxé…ç½® â­
â”‚   â”œâ”€â”€ README.md             # Nginxé…ç½®è¯´æ˜
â”‚   â””â”€â”€ dingtalk-bot.conf     # Nginxä¸»é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ systemd/                   # ğŸ”§ SystemdæœåŠ¡é…ç½® â­
â”‚   â”œâ”€â”€ README.md             # Systemdé…ç½®è¯´æ˜
â”‚   â”œâ”€â”€ dingtalk-bot.service  # é’‰é’‰æœºå™¨äººæœåŠ¡
â”‚   â””â”€â”€ image-server.service  # å›¾ç‰‡æœåŠ¡å™¨æœåŠ¡
â”‚
â”œâ”€â”€ scripts/                   # ğŸ“œ ç®¡ç†è„šæœ¬ â­
â”‚   â”œâ”€â”€ README.md             # è„šæœ¬ä½¿ç”¨è¯´æ˜
â”‚   â”œâ”€â”€ start.sh              # ä¸€é”®å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ stop.sh               # åœæ­¢æœåŠ¡è„šæœ¬
â”‚   â”œâ”€â”€ status.sh             # çŠ¶æ€æŸ¥çœ‹è„šæœ¬
â”‚   â”œâ”€â”€ docker-deploy.sh      # Dockeréƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ docker-start.sh       # Dockerå¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ docker-stop.sh        # Dockeråœæ­¢è„šæœ¬
â”‚   â”œâ”€â”€ docker-status.sh      # DockerçŠ¶æ€è„šæœ¬
â”‚   â”œâ”€â”€ check_async_status.sh # å¼‚æ­¥åŠŸèƒ½æ£€æŸ¥
â”‚   â”œâ”€â”€ verify_image_server.sh # å›¾ç‰‡æœåŠ¡å™¨éªŒè¯
â”‚   â””â”€â”€ monitor_markdown.sh   # Markdownç›‘æ§
â”‚
â”œâ”€â”€ Dockerfile                 # Docker é•œåƒæ„å»ºæ–‡ä»¶
â””â”€â”€ docker-compose.yml         # Docker Compose é…ç½®
```

**â­ æ ‡è®°çš„æ˜¯æ–°å¢æˆ–é‡è¦åŠŸèƒ½ç›¸å…³æ–‡ä»¶**

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šDocker ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url> /root/project-wb/dingtalk_bot
cd /root/project-wb/dingtalk_bot
```

#### 2. ä¸€é”®éƒ¨ç½²

```bash
sudo ./docker-deploy.sh
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥å¹¶å®‰è£… Docker å’Œ Docker Compose
- åˆ›å»ºé¡¹ç›®ç›®å½•
- åˆ›å»ºé…ç½®æ–‡ä»¶
- æ„å»º Docker é•œåƒ
- å¯åŠ¨æœåŠ¡

#### 3. Docker ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
./scripts/docker-status.sh

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
./scripts/docker-stop.sh

# å¯åŠ¨æœåŠ¡
./scripts/docker-start.sh

# é‡å¯æœåŠ¡
docker-compose restart

# è¿›å…¥å®¹å™¨
docker-compose exec dingtalk-bot bash
```

#### 4. Docker æ•°æ®æŒä¹…åŒ–

Docker éƒ¨ç½²ä½¿ç”¨ä»¥ä¸‹æ•°æ®å·ï¼š
- `./images` - å›¾ç‰‡å­˜å‚¨ç›®å½•
- `./logs` - æ—¥å¿—å­˜å‚¨ç›®å½•
- `./.env` - é…ç½®æ–‡ä»¶

å®¹å™¨åˆ é™¤åæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

### æ–¹å¼äºŒï¼šSystemd ä¸€é”®è„šæœ¬éƒ¨ç½²

#### 1. ç³»ç»Ÿè¦æ±‚

- æ“ä½œç³»ç»Ÿï¼šLinux (CentOS 7+, Ubuntu 18.04+, TencentOS ç­‰)
- Pythonï¼š3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- å†…å­˜ï¼šæœ€ä½ 256MBï¼Œæ¨è 512MB
- ç½‘ç»œï¼šèƒ½å¤Ÿè®¿é—®é’‰é’‰æœåŠ¡å™¨å’Œ CodeBuddy API

#### 2. ä¸€é”®å¯åŠ¨

```bash
cd /root/project-wb/dingtalk_bot
sudo ./scripts/start.sh
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥ root æƒé™
- æ£€æŸ¥å¹¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
- æ£€æŸ¥ .env é…ç½®æ–‡ä»¶
- å®‰è£… systemd æœåŠ¡
- å®‰è£… Python ä¾èµ–
- å¯åŠ¨æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯

#### 3. ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
./scripts/status.sh

# åœæ­¢æœåŠ¡
sudo ./scripts/stop.sh

# å¯åŠ¨æœåŠ¡
sudo ./scripts/start.sh

# é‡å¯æœåŠ¡
sudo systemctl restart dingtalk-bot

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/dingtalk-bot.log
```

#### 4. æ‰‹åŠ¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸æƒ³ä½¿ç”¨ä¸€é”®è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨éƒ¨ç½²ï¼š

```bash
# å®‰è£…ä¾èµ–
cd /root/project-wb/dingtalk_bot
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env

# å®‰è£… Systemd æœåŠ¡
sudo cp systemd/dingtalk-bot.service /etc/systemd/system/
sudo cp systemd/image-server.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl start dingtalk-bot
sudo systemctl enable dingtalk-bot

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status dingtalk-bot

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo tail -f /var/log/dingtalk-bot.log
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

ç¼–è¾‘ `.env` æ–‡ä»¶é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

#### é’‰é’‰é…ç½®

```bash
# ä»é’‰é’‰å¼€æ”¾å¹³å°è·å–
DINGTALK_CLIENT_ID=your_client_id_here
DINGTALK_CLIENT_SECRET=your_client_secret_here
DINGTALK_APP_ID=your_app_id_here
```

#### å›¾ç‰‡æœåŠ¡å™¨é…ç½® â­

```bash
# å›¾ç‰‡æœåŠ¡å™¨é…ç½®
IMAGE_SERVER_URL=http://119.28.50.67/dingtalk-images
IMAGE_SERVER_PORT=8090

# CodeBuddy API é…ç½®
CODEBUDDY_API_URL=http://119.28.50.67/agent
CODEBUDDY_API_TOKEN=your_token_here
```

#### CodeBuddy API è¯·æ±‚å‚æ•°

```bash
# å·¥ä½œç›®å½•ï¼ˆæ”¯æŒå¤šä¸ªç›®å½•ç”¨é€—å·åˆ†éš”ï¼‰
CODEBUDDY_ADD_DIR=/root/project-wb,/root/other-project

# ä½¿ç”¨çš„æ¨¡å‹
CODEBUDDY_MODEL=kimi-k2.5-ioa

# æ˜¯å¦ç»§ç»­å¯¹è¯ï¼ˆtrue/falseï¼‰
CODEBUDDY_CONTINUE=true

# æ˜¯å¦æ‰“å°è¾“å‡ºï¼ˆtrue/falseï¼‰
CODEBUDDY_PRINT=true

# æ˜¯å¦è·³è¿‡æƒé™æ£€æŸ¥ï¼ˆtrue/falseï¼‰
CODEBUDDY_SKIP_PERMISSIONS=true
```

#### æ—¥å¿—é…ç½®

```bash
# æ—¥å¿—çº§åˆ«ï¼šDEBUG, INFO, WARNING, ERROR
LOG_LEVEL=INFO
```

#### Markdown æ¶ˆæ¯é…ç½® â­

```bash
# æ˜¯å¦å¯ç”¨ Markdown æ ¼å¼æ¶ˆæ¯
ENABLE_MARKDOWN=true

# å¼‚æ­¥ä»»åŠ¡ç»“æœæ˜¯å¦ä½¿ç”¨ Markdown æ ¼å¼
USE_MARKDOWN_FOR_ASYNC=true

# é•¿æ–‡æœ¬ç»“æœæ˜¯å¦ä½¿ç”¨ Markdown æ ¼å¼
USE_MARKDOWN_FOR_LONG_TEXT=false

# æ˜¯å¦è‡ªåŠ¨å¢å¼º Markdown æ ¼å¼
AUTO_ENHANCE_MARKDOWN=true
```

### CodeBuddy API è¯·æ±‚æ ¼å¼

å®é™…å‘é€åˆ° CodeBuddy çš„è¯·æ±‚æ ¼å¼ï¼š

```bash
curl -X POST http://IP:PORT/agent \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "prompt": "ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹",
    "addDir": ["/root/project-wb"],
    "model": "kimi-k2.5-ioa",
    "continue": true,
    "print": true,
    "dangerouslySkipPermissions": true
  }'
```

**å‚æ•°è¯´æ˜**ï¼š
- `prompt`: ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯å†…å®¹
- `addDir`: å·¥ä½œç›®å½•æ•°ç»„ï¼ŒCodeBuddy å¯è®¿é—®çš„ç›®å½•
- `model`: ä½¿ç”¨çš„ AI æ¨¡å‹
- `continue`: æ˜¯å¦ç»§ç»­ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡
- `print`: æ˜¯å¦æ‰“å°è¯¦ç»†è¾“å‡º
- `dangerouslySkipPermissions`: æ˜¯å¦è·³è¿‡æƒé™æ£€æŸ¥

## éƒ¨ç½²æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Docker éƒ¨ç½² | Systemd éƒ¨ç½² |
|------|------------|-------------|
| éƒ¨ç½²éš¾åº¦ | â­ ä¸€é”®éƒ¨ç½² | â­â­ éœ€è¦é…ç½® |
| ç¯å¢ƒéš”ç¦» | âœ… å®Œå…¨éš”ç¦» | âŒ ä¾èµ–å®¿ä¸»æœº |
| èµ„æºå ç”¨ | ç¨é«˜ | è¾ƒä½ |
| æ•°æ®æŒä¹…åŒ– | âœ… æ•°æ®å· | âœ… æœ¬åœ°ç›®å½• |
| æ—¥å¿—ç®¡ç† | Docker æ—¥å¿— | ç³»ç»Ÿæ—¥å¿— |
| é€‚ç”¨åœºæ™¯ | ç”Ÿäº§ç¯å¢ƒã€å¤šå®ä¾‹ | å•æœºã€å¼€å‘æµ‹è¯• |

## é’‰é’‰é…ç½®

### æ­¥éª¤ 1ï¼šåˆ›å»ºä¼ä¸šå†…éƒ¨åº”ç”¨

1. ç™»å½• https://open.dingtalk.com/
2. ç‚¹å‡»å³ä¸Šè§’ "å¼€å‘è€…åå°"
3. é€‰æ‹©ä½ çš„ä¼ä¸šç»„ç»‡
4. ç‚¹å‡» "åº”ç”¨å¼€å‘" â†’ "ä¼ä¸šå†…éƒ¨åº”ç”¨"
5. ç‚¹å‡» "åˆ›å»ºåº”ç”¨"

### æ­¥éª¤ 2ï¼šå¡«å†™åº”ç”¨ä¿¡æ¯

- **åº”ç”¨åç§°**ï¼šCodeBuddy Assistantï¼ˆæˆ–è‡ªå®šä¹‰ï¼‰
- **åº”ç”¨æè¿°**ï¼šAI åŠ©æ‰‹ï¼ŒåŸºäº CodeBuddy æä¾›æ™ºèƒ½é—®ç­”æœåŠ¡
- **åº”ç”¨å›¾æ ‡**ï¼šä¸Šä¼ ä½ çš„åº”ç”¨å›¾æ ‡
- **å¼€å‘æ–¹å¼**ï¼šä¼ä¸šè‡ªåŠ©å¼€å‘

### æ­¥éª¤ 3ï¼šé…ç½®æœºå™¨äºº

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µï¼Œç‚¹å‡»å·¦ä¾§ "æœºå™¨äºº"
2. æ‰“å¼€ "æœºå™¨äºº" å¼€å…³
3. é…ç½®æœºå™¨äººï¼š
   - **æ¶ˆæ¯æ¥æ”¶æ¨¡å¼**ï¼šé€‰æ‹© "Stream æ¨¡å¼"ï¼ˆé‡è¦ï¼ï¼‰
   - **æœºå™¨äººåç§°**ï¼šCodeBuddy Bot
   - **æè¿°**ï¼šæ™ºèƒ½ AI åŠ©æ‰‹

### æ­¥éª¤ 4ï¼šè·å–å‡­è¯

1. ç‚¹å‡»å·¦ä¾§ "å‡­è¯ä¸åŸºç¡€ä¿¡æ¯"
2. å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š
   - Client ID (åŸ AppKey)
   - Client Secret (åŸ AppSecret)
3. å°†è¿™äº›ä¿¡æ¯å¡«å…¥ `.env` æ–‡ä»¶çš„å¯¹åº”ä½ç½®

### æ­¥éª¤ 5ï¼šå‘å¸ƒåº”ç”¨

1. ç‚¹å‡»å·¦ä¾§ "ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒ"
2. ç‚¹å‡» "åˆ›å»ºæ–°ç‰ˆæœ¬"
3. å¡«å†™ç‰ˆæœ¬ä¿¡æ¯ï¼š
   - ç‰ˆæœ¬å·ï¼š1.0.0
   - ç‰ˆæœ¬æè¿°ï¼šåˆå§‹ç‰ˆæœ¬
4. ç‚¹å‡» "ä¿å­˜" â†’ "å‘å¸ƒ"

### æ­¥éª¤ 6ï¼šæ·»åŠ åº”ç”¨åˆ°ä¼ä¸š

1. åœ¨ "ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒ" é¡µé¢
2. ç‚¹å‡» "æ·»åŠ åº”ç”¨è‡³ä¼ä¸š"
3. é€‰æ‹©éœ€è¦ä½¿ç”¨æœºå™¨äººçš„éƒ¨é—¨
4. ç‚¹å‡» "ç¡®å®š"

### æ­¥éª¤ 7ï¼šç¾¤èŠé…ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åœ¨ç¾¤èŠä¸­ä½¿ç”¨ï¼š
1. æ‰“å¼€ç›®æ ‡ç¾¤èŠ
2. ç‚¹å‡»å³ä¸Šè§’ "ç¾¤è®¾ç½®"ï¼ˆé½¿è½®å›¾æ ‡ï¼‰
3. é€‰æ‹© "æ™ºèƒ½ç¾¤åŠ©æ‰‹"
4. ç‚¹å‡» "æ·»åŠ æœºå™¨äºº"
5. é€‰æ‹© "CodeBuddy Assistant"
6. ç‚¹å‡» "ç¡®å®š"

## æœåŠ¡ç®¡ç†

### Docker éƒ¨ç½²

```bash
# æŸ¥çœ‹çŠ¶æ€
./docker-status.sh

# å¯åŠ¨æœåŠ¡
./docker-start.sh

# åœæ­¢æœåŠ¡
./docker-stop.sh

# é‡å¯æœåŠ¡
docker-compose restart

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# è¿›å…¥å®¹å™¨
docker-compose exec dingtalk-bot bash
```

### Systemd éƒ¨ç½²

```bash
# æŸ¥çœ‹çŠ¶æ€
./scripts/status.sh

# å¯åŠ¨æœåŠ¡
sudo ./scripts/start.sh

# åœæ­¢æœåŠ¡
sudo ./scripts/stop.sh

# é‡å¯æœåŠ¡
sudo systemctl restart dingtalk-bot

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/dingtalk-bot.log
```

## ä½¿ç”¨æŒ‡å—

### å•èŠä½¿ç”¨

1. åœ¨é’‰é’‰ä¸­æœç´¢ "CodeBuddy Assistant"ï¼ˆæˆ–ä½ çš„åº”ç”¨åç§°ï¼‰
2. è¿›å…¥èŠå¤©çª—å£
3. ç›´æ¥å‘é€æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
   - "ä½ å¥½"
   - "2+2ç­‰äºå‡ "
   - "å¸®æˆ‘å†™ä¸€æ®µ Python ä»£ç "

### ç¾¤èŠä½¿ç”¨

1. åœ¨å·²æ·»åŠ æœºå™¨äººçš„ç¾¤èŠä¸­
2. @æœºå™¨äºº å¹¶å‘é€æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
   - "@CodeBuddy Bot ä½ å¥½"
   - "@CodeBuddy Bot è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½"

### å›¾ç‰‡å¤„ç†

- **çº¯å›¾ç‰‡**ï¼šç›´æ¥å‘é€å›¾ç‰‡ï¼Œæœºå™¨äººä¼šåˆ†æå›¾ç‰‡å†…å®¹
- **æ–‡å­—+å›¾ç‰‡**ï¼šå‘é€æ–‡å­—å¹¶é™„åŠ å›¾ç‰‡ï¼Œæœºå™¨äººä¼šç»“åˆæ–‡å­—å’Œå›¾ç‰‡è¿›è¡Œåˆ†æ

## æ¶ˆæ¯å¤„ç†æµç¨‹

### çº¯æ–‡å­—æ¶ˆæ¯

```
ç”¨æˆ·å‘é€æ–‡å­— -> æœºå™¨äººç«‹å³å›å¤"æ”¶åˆ°ä»»åŠ¡" -> è°ƒç”¨ CodeBuddy API -> è¿”å›ç»“æœç»™ç”¨æˆ·
```

### çº¯å›¾ç‰‡æ¶ˆæ¯

```
ç”¨æˆ·å‘é€å›¾ç‰‡ -> æœºå™¨äººç«‹å³å›å¤"æ”¶åˆ°ä»»åŠ¡" -> ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ° -> è°ƒç”¨ CodeBuddy API(å›¾ç‰‡è·¯å¾„) -> è¿”å›ç»“æœç»™ç”¨æˆ·
```

### å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼ˆæ–‡å­—+å›¾ç‰‡ï¼‰

```
ç”¨æˆ·å‘é€æ–‡å­—+å›¾ç‰‡ -> æœºå™¨äººç«‹å³å›å¤"æ”¶åˆ°ä»»åŠ¡" -> ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ° -> è°ƒç”¨ CodeBuddy API(æ–‡å­—+å›¾ç‰‡è·¯å¾„) -> è¿”å›ç»“æœç»™ç”¨æˆ·
```

## API è°ƒç”¨æ ¼å¼

### çº¯æ–‡å­—

```json
{
  "prompt": "ç”¨æˆ·è¾“å…¥çš„æ–‡å­—",
  "print": true,
  "dangerouslySkipPermissions": true
}
```

### çº¯å›¾ç‰‡

```json
{
  "prompt": "åˆ†æè¿™å¼ å›¾ç‰‡ï¼š/path/to/image.jpg",
  "print": true,
  "dangerouslySkipPermissions": true
}
```

### æ–‡å­—+å›¾ç‰‡

```json
{
  "prompt": "ç”¨æˆ·è¾“å…¥çš„æ–‡å­— å›¾ç‰‡è·¯å¾„ï¼š/path/to/image.jpg",
  "print": true,
  "dangerouslySkipPermissions": true
}
```

## æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

**ç°è±¡**ï¼š`systemctl start dingtalk-bot` å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥é…ç½®æ–‡ä»¶
   ```bash
   cat /root/project-wb/dingtalk_bot/.env
   ```
   ç¡®ä¿ DINGTALK_CLIENT_ID å’Œ DINGTALK_CLIENT_SECRET å·²æ­£ç¡®å¡«å†™

2. æ£€æŸ¥æ—¥å¿—
   ```bash
   sudo tail -n 50 /var/log/dingtalk-bot.log
   ```

3. æ‰‹åŠ¨æµ‹è¯•è¿è¡Œ
   ```bash
   cd /root/project-wb/dingtalk_bot
   source venv/bin/activate
   python bot.py
   ```

### æ”¶ä¸åˆ°æ¶ˆæ¯

**ç°è±¡**ï¼šåœ¨é’‰é’‰å‘é€æ¶ˆæ¯ï¼Œæœºå™¨äººæ²¡æœ‰å“åº”

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
   ```bash
   sudo systemctl status dingtalk-bot
   ```

2. æ£€æŸ¥ç½‘ç»œè¿æ¥
   ```bash
   curl -I https://api.dingtalk.com
   ```

3. æ£€æŸ¥é’‰é’‰åº”ç”¨é…ç½®
   - ç¡®è®¤åº”ç”¨å·²å‘å¸ƒ
   - ç¡®è®¤æœºå™¨äººå·²å¯ç”¨ Stream æ¨¡å¼
   - ç¡®è®¤åº”ç”¨å·²æ·»åŠ åˆ°ä¼ä¸š

4. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
   ```bash
   sudo tail -f /var/log/dingtalk-bot.log
   ```

### CodeBuddy API è°ƒç”¨å¤±è´¥

**ç°è±¡**ï¼šæ”¶åˆ°æ¶ˆæ¯ä½†æ— å›å¤ï¼Œæ—¥å¿—æ˜¾ç¤º API é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ API é…ç½®
   ```bash
   grep CODEBUDDY /root/project-wb/dingtalk_bot/.env
   ```

2. æµ‹è¯• API è¿é€šæ€§
   ```bash
   curl -X POST http://your-codebuddy-server/agent \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer your_token" \
     -d '{"prompt": "test", "print": true}'
   ```

3. æ£€æŸ¥ç½‘ç»œè®¿é—®
   ```bash
   ping your-codebuddy-server
   ```

### å›¾ç‰‡ä¸‹è½½å¤±è´¥

**ç°è±¡**ï¼šå‘é€å›¾ç‰‡åè¿”å›"å›¾ç‰‡ä¸‹è½½å¤±è´¥"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ access_token è·å–æ˜¯å¦æˆåŠŸ
2. æ£€æŸ¥å›¾ç‰‡ä¸‹è½½æ¥å£æ˜¯å¦è¿”å›æ­£ç¡®çš„ä¸‹è½½é“¾æ¥
3. æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®é˜¿é‡Œäº‘ OSS

## å¸¸è§é—®é¢˜

**Q: æœºå™¨äººå“åº”å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ**

A: å“åº”é€Ÿåº¦å–å†³äº CodeBuddy API çš„å¤„ç†é€Ÿåº¦ã€‚å¯ä»¥ï¼š
1. æ£€æŸ¥ CodeBuddy æœåŠ¡å™¨æ€§èƒ½
2. æŸ¥çœ‹ç½‘ç»œå»¶è¿Ÿ
3. è€ƒè™‘ä½¿ç”¨æ›´å¿«çš„ç½‘ç»œè¿æ¥

**Q: å¦‚ä½•ä¿®æ”¹æ¶ˆæ¯é•¿åº¦é™åˆ¶ï¼Ÿ**

A: ç¼–è¾‘ `config.py` æ–‡ä»¶ï¼š
```python
MAX_MESSAGE_LENGTH = 20000  # ä¿®æ”¹ä¸ºéœ€è¦çš„å€¼
```
ç„¶åé‡å¯æœåŠ¡ï¼š
```bash
sudo systemctl restart dingtalk-bot
```

**Q: å¦‚ä½•ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Ÿ**

A: ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```bash
LOG_LEVEL=DEBUG  # å¯é€‰ï¼šDEBUG, INFO, WARNING, ERROR
```
ç„¶åé‡å¯æœåŠ¡ã€‚

**Q: å¦‚ä½•æ›´æ–°æœºå™¨äººä»£ç ï¼Ÿ**

A:
```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop dingtalk-bot

# æ›´æ–°ä»£ç 
# ... ä½ çš„æ›´æ–°æ“ä½œ ...

# å¯åŠ¨æœåŠ¡
sudo systemctl start dingtalk-bot
```

**Q: ä¸€ä¸ªæœºå™¨äººå¯ä»¥åœ¨å¤šä¸ªç¾¤ä½¿ç”¨å—ï¼Ÿ**

A: å¯ä»¥ã€‚åªéœ€è¦åœ¨æ¯ä¸ªç¾¤ä¸­æ·»åŠ åŒä¸€ä¸ªæœºå™¨äººå³å¯ã€‚

**Q: å¦‚ä½•æŸ¥çœ‹å½“å‰æœ‰å“ªäº›ç”¨æˆ·åœ¨ä½¿ç”¨æœºå™¨äººï¼Ÿ**

A: æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```bash
sudo grep "æ”¶åˆ°æ¶ˆæ¯" /var/log/dingtalk-bot.log
```

## æŠ€æœ¯æ”¯æŒ

### é’‰é’‰å¼€æ”¾å¹³å°æ–‡æ¡£

- https://open.dingtalk.com/
- https://open.dingtalk.com/document/isvapp-server/stream-introduction

### é¡¹ç›®ç›¸å…³

- dingtalk-stream SDK: https://github.com/open-dingtalk/dingtalk-stream-sdk-python

### æ—¥å¿—ä½ç½®

- åº”ç”¨æ—¥å¿—ï¼š`/var/log/dingtalk-bot.log`
- é¡¹ç›®æ—¥å¿—ï¼š`/root/project-wb/dingtalk_bot/logs/dingtalk_bot.log`

## æ›´æ–°æ—¥å¿—

### v1.2.0 (2026-03-01)

- âœ¨ æ–°å¢å›¾ç‰‡ç”ŸæˆåŠŸèƒ½
  - æ–‡ç”Ÿå›¾ï¼šé€šè¿‡æ–‡æœ¬æè¿°ç”Ÿæˆå›¾ç‰‡
  - å›¾ç”Ÿå›¾ï¼šä¸Šä¼ å›¾ç‰‡è¿›è¡Œç¼–è¾‘å’Œå˜æ¢
  - HTTPé™æ€æœåŠ¡å™¨éƒ¨ç½²ï¼ˆç«¯å£8090ï¼‰
  - Nginxåå‘ä»£ç†é…ç½®
  - é’‰é’‰åŸç”Ÿå›¾ç‰‡æ¶ˆæ¯å±•ç¤º
- ğŸ”§ ä¿®å¤æ¶ˆæ¯å»é‡æœºåˆ¶
  - è§£å†³é‡å¤æ¶ˆæ¯é—®é¢˜
  - ä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€»è¾‘
- ğŸ”§ ä¿®å¤å›¾ç‰‡æœåŠ¡å™¨è®¿é—®é—®é¢˜
  - é…ç½®IMAGE_SERVER_URLç¯å¢ƒå˜é‡
  - é…ç½®Nginxåå‘ä»£ç†è§£å†³ç«¯å£è®¿é—®é™åˆ¶
- ğŸ”§ ä¿®å¤CodeBuddy APIè®¿é—®é—®é¢˜
  - é…ç½®Nginxåå‘ä»£ç†æ”¯æŒ/agentè·¯å¾„
  - è¶…æ—¶è®¾ç½®ä¼˜åŒ–ï¼ˆ300ç§’ï¼‰
  - ç¦ç”¨ç¼“å†²æ”¯æŒæµå¼å“åº”
- ğŸ“ é¡¹ç›®ç»“æ„é‡ç»„
  - åˆ›å»ºdocs/ç›®å½•åˆ†ç±»ç®¡ç†æ–‡æ¡£
  - deployment/éƒ¨ç½²æ–‡æ¡£
  - troubleshooting/æ•…éšœæ’æŸ¥æ–‡æ¡£
  - features/åŠŸèƒ½æ–‡æ¡£
  - testing/æµ‹è¯•æ–‡æ¡£
  - architecture/æ¶æ„æ–‡æ¡£

### v1.1.0 (2026-02-28)

- âœ¨ æ–°å¢ Markdown æ¶ˆæ¯æ ¼å¼æ”¯æŒ
  - è‡ªåŠ¨æ£€æµ‹ API è¿”å›çš„ Markdown æ ¼å¼
  - æ”¯æŒé’‰é’‰åŸç”Ÿ Markdown æ¶ˆæ¯ç±»å‹
  - çµæ´»é…ç½®é€‰é¡¹
- ğŸ“ æ–°å¢ Markdown ç›¸å…³æ–‡æ¡£
  - MARKDOWN_SUPPORT.md - å®Œæ•´åŠŸèƒ½æ–‡æ¡£
  - TEST_MARKDOWN.md - æµ‹è¯•æŒ‡å—
  - MARKDOWN_DEPLOYMENT.md - éƒ¨ç½²æŒ‡å—
- âœ… é€šè¿‡å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### v1.0.0 (2026-02-15)

- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒ Stream æ¨¡å¼
- æ”¯æŒç¾¤èŠå’Œå•èŠ
- æ”¯æŒæ–‡å­—ã€å›¾ç‰‡ã€å¯Œæ–‡æœ¬æ¶ˆæ¯
- é›†æˆ Systemd æœåŠ¡
- æ”¯æŒå¼‚æ­¥ä»»åŠ¡å¤„ç†å’Œä¸»åŠ¨æ¨é€

## å®‰å…¨å»ºè®®

1. **ä¿æŠ¤å‡­è¯ä¿¡æ¯**
   - ä¸è¦å°† `.env` æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
   - å®šæœŸæ›´æ¢ Client Secret
   - é™åˆ¶æœåŠ¡å™¨è®¿é—®æƒé™

2. **ç½‘ç»œå®‰å…¨**
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶ä¸å¿…è¦çš„ç«¯å£è®¿é—®
   - è€ƒè™‘ä½¿ç”¨ HTTPS ä»£ç† CodeBuddy API
   - å®šæœŸæ£€æŸ¥æœåŠ¡å™¨å®‰å…¨æ›´æ–°

3. **æ—¥å¿—å®‰å…¨**
   - å®šæœŸæ¸…ç†æ—§æ—¥å¿—
   - ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
   - é™åˆ¶æ—¥å¿—æ–‡ä»¶è®¿é—®æƒé™

4. **æœåŠ¡å®‰å…¨**
   - ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡ŒæœåŠ¡ï¼ˆè€Œé rootï¼‰
   - å®šæœŸæ›´æ–°ä¾èµ–åŒ…
   - ç›‘æ§æœåŠ¡å¼‚å¸¸è¡Œä¸º

## æ–‡æ¡£ç‰ˆæœ¬

- ç‰ˆæœ¬: 1.2.0
- æœ€åæ›´æ–°: 2026-03-01
- ç»´æŠ¤è€…: CodeBuddy Team
